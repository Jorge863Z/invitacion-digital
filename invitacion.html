<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invitación Digital - Evento Especial</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Lucide Icons (Iconos) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Playfair+Display:ital,wght@0,400..900;1,400..900&display=swap');
        
        :root {
            --primary-color: #A32D50; /* Vino/Borgoña */
            --secondary-color: #F8F4E3; /* Beige Claro */
            --accent-color: #D9A440; /* Oro */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--secondary-color);
            color: #333;
        }

        .header-font {
            font-family: 'Playfair Display', serif;
        }

        .card {
            background-color: white;
            border-radius: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #852243;
        }
        
        .btn-secondary {
            background-color: var(--accent-color);
            color: white;
            transition: background-color 0.3s ease;
        }

        .btn-secondary:hover {
            background-color: #c99333;
        }

        /* Estilo para el modo admin */
        .admin-view {
            background-color: #333;
            color: white;
        }

        /* Estilo para el Toast que mostrará el link */
        #toast-message.link-toast {
            min-width: 300px;
            display: block;
            padding: 0;
            cursor: pointer;
        }

        /* Nuevo estilo para la cuenta regresiva compacta */
        .countdown-item {
            padding: 0.5rem;
            text-align: center;
            border-radius: 0.5rem;
            background-color: var(--secondary-color);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        .countdown-item p:first-child {
            font-size: 1.5rem; /* 24px */
            font-weight: 800; /* Extra bold */
            line-height: 1.2;
        }

        /* --- LIGHTBOX MEJORADO --- */
        #lightbox {
            display: none; /* Oculto por defecto */
            position: fixed;
            z-index: 9999; /* Asegura que esté ENCIMA de todo */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95); /* Fondo casi negro */
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        
        #lightbox.active {
            display: flex;
        }

        #lightbox-img {
            max-width: 95%;
            max-height: 90vh;
            border-radius: 4px;
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
            object-fit: contain;
        }

        #lightbox-close {
            position: absolute;
            top: 15px;
            right: 25px;
            color: #fff;
            font-size: 3rem;
            font-weight: 300;
            cursor: pointer;
            z-index: 10000;
            line-height: 1;
            transition: color 0.3s;
        }

        #lightbox-close:hover {
            color: var(--accent-color);
        }

        /* Cursor de mano en las fotos de la galería */
        .gallery-img {
            cursor: pointer;
            transition: transform 0.2s, opacity 0.2s;
        }
        .gallery-img:hover {
            transform: scale(1.02);
            opacity: 0.95;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center p-4">

    <!-- Mensaje Toast (No usar alert()) -->
    <div id="toast-message" class="fixed top-5 z-50 p-4 rounded-lg shadow-xl text-white transition-opacity duration-300 opacity-0 hidden" role="alert"></div>

    <!-- LIGHTBOX (Visor de Fotos) -->
    <div id="lightbox">
        <span id="lightbox-close">&times;</span>
        <img id="lightbox-img" src="">
    </div>

    <!-- Contenedor Principal (Vista Invitado/Admin) -->
    <main id="app-container" class="w-full max-w-4xl space-y-6 pb-12">

        <!-- Botón de Acceso Admin (Flotante y discreto) -->
        <button id="admin-login-btn" class="fixed bottom-4 right-4 bg-gray-700 text-white p-3 rounded-full shadow-lg z-20 hover:bg-gray-900 transition-colors">
            <i data-lucide="shield-check" class="w-5 h-5"></i>
        </button>

        <!-- MODO INVITADO -->
        <div id="guest-view" class="space-y-6">
            
            <!-- SECCIÓN 1: Bienvenida -->
            <section class="text-center py-10 bg-white card shadow-2xl">
                <h1 class="header-font text-5xl md:text-7xl font-bold text-gray-800" id="event-title">
                    ¡Nuestro Gran Día!
                </h1>
                <p class="mt-4 text-xl text-gray-600">
                    <span id="names-placeholder">Nombre Novio & Nombre Novia</span>
                </p>
                <p class="text-lg mt-2 text-gray-500">
                    Te esperamos para celebrar nuestro amor.
                </p>
            </section>

            <!-- SECCIÓN 2: Cuenta Regresiva -->
            <section class="card text-center border-b-4 border-t-4 border-accent-color p-4">
                <h2 class="text-xl font-semibold mb-3 text-primary-color flex items-center justify-center">
                    <i data-lucide="clock" class="w-5 h-5 mr-2"></i> Cuenta Regresiva
                </h2>
                <div id="countdown" class="grid grid-cols-5 gap-2 text-primary-color font-mono">
                    <!-- JS llenará esto -->
                </div>
            </section>

            <!-- SECCIÓN 3: MÚSICA (ARRIBA) -->
            <section class="card p-6">
                <h2 class="header-font text-3xl font-bold text-center mb-6 text-primary-color">Música del Evento</h2>
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-4">Toca el botón "Play" para ambientar tu lectura.</p>
                    <iframe 
                        style="border-radius:12px" 
                        src="https://open.spotify.com/embed/track/2S5kI2Q1R0wEToqW6x7v5a?utm_source=generator&theme=0" 
                        width="100%" 
                        height="152" 
                        frameBorder="0" 
                        allowfullscreen="" 
                        allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" 
                        loading="lazy"
                    ></iframe>
                </div>
            </section>
            
            <!-- SECCIÓN 4: CÓDIGO DE VESTIMENTA -->
            <section class="card p-6 bg-gray-50 border-t border-b border-primary-color">
                <div class="grid grid-cols-1 gap-4">
                    <div class="space-y-3 text-center">
                        <h3 class="header-font text-2xl font-bold text-primary-color flex items-center justify-center">
                            <i data-lucide="shirt" class="w-6 h-6 mr-2 text-accent-color"></i> Código de Vestimenta
                        </h3>
                        <div id="dress-code" class="text-lg font-bold text-gray-700 p-3 rounded-lg bg-white shadow-md mx-auto max-w-lg border border-gray-200">
                            <!-- Se llena con JS -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- SECCIÓN 5: FOTOS -->
            <section class="space-y-4 pt-0 mt-[-24px]"> 
                <h2 class="header-font text-3xl font-bold text-center text-primary-color">Nuestras Fotos</h2>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <img src="fotoboda1.jpg" onerror="this.src='https://placehold.co/400x300/A32D50/F8F4E3?text=Foto+1'" alt="Foto 1" class="gallery-img rounded-lg shadow-md w-full h-auto object-cover aspect-square">
                    <img src="https://placehold.co/400x300/D9A440/333?text=Foto+2" alt="Foto 2" class="gallery-img rounded-lg shadow-md w-full h-auto object-cover aspect-square">
                    <img src="https://placehold.co/400x300/852243/FFF?text=Foto+3" alt="Foto 3" class="gallery-img rounded-lg shadow-md w-full h-auto object-cover aspect-square hidden md:block">
                    <img src="https://placehold.co/400x300/333/F8F4E3?text=Foto+4" alt="Foto 4" class="gallery-img rounded-lg shadow-md w-full h-auto object-cover aspect-square hidden md:block">
                </div>
            </section>

            <!-- SECCIÓN 6: UBICACIÓN -->
            <section class="card p-6">
                <h2 class="header-font text-3xl font-bold text-center mb-6 text-primary-color">Ubicación del Evento</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="location-container">
                    <!-- JS -->
                </div>
            </section>
            
            <!-- SECCIÓN 7: RSVP -->
            <section class="card p-6">
                <h2 class="header-font text-3xl font-bold text-center mb-6 text-primary-color">Tu Invitación</h2>
                <div id="guest-details-loading" class="text-center text-gray-500">Cargando detalles...</div>
                <div id="guest-details" class="hidden space-y-4">
                    <div class="text-center p-4 bg-secondary-color rounded-lg border border-accent-color">
                        <p class="text-lg font-semibold text-gray-700">¡Hola, <span id="guest-name-display" class="text-primary-color font-bold">Invitado</span>!</p>
                        <p class="text-md mt-2">Te esperamos en la **Mesa <span id="guest-table-display" class="font-bold text-primary-color">#</span>**.</p>
                        <p class="text-md">Puedes confirmar la asistencia de hasta **<span id="guest-count-display" class="font-bold text-primary-color">1</span>** persona(s).</p>
                    </div>
                    <p id="rsvp-status-message" class="text-center text-xl font-bold mt-4"></p>
                    <div id="rsvp-actions" class="mt-6 space-y-4">
                        <h3 class="text-xl font-semibold mb-4 text-center">Confirma tu Asistencia</h3>
                        <div class="flex flex-col space-y-4 md:flex-row md:space-y-0 md:space-x-4">
                            <button id="btn-confirm-attendance" class="btn-primary w-full py-3 rounded-xl flex items-center justify-center font-bold"><i data-lucide="check-circle" class="w-5 h-5 mr-2"></i> Confirmo Asistencia</button>
                            <button id="btn-not-attending" class="btn-secondary w-full py-3 rounded-xl flex items-center justify-center font-bold"><i data-lucide="x-circle" class="w-5 h-5 mr-2"></i> No Asistiré</button>
                        </div>
                        <button id="btn-whatsapp-prompt" class="bg-green-500 hover:bg-green-600 text-white w-full py-3 rounded-xl flex items-center justify-center font-bold transition-colors"><i data-lucide="send" class="w-5 h-5 mr-2"></i> Enviar WhatsApp al Anfitrión</button>
                    </div>
                </div>
            </section>

            <!-- SECCIÓN 8: REGALOS (SIMÉTRICO) -->
            <section class="card p-6 bg-gray-50">
                <h2 class="header-font text-3xl font-bold text-center mb-2 text-primary-color">Mesa de Regalos</h2>
                <p class="text-center text-gray-500 text-sm mb-8 max-w-md mx-auto">Su presencia es nuestro mejor regalo, pero si deseas tener un detalle con nosotros, estas son las opciones.</p>
                <div id="gift-actions" class="grid grid-cols-1 md:grid-cols-2 gap-4 items-stretch"> 
                    <!-- Opción 1 -->
                    <div class="p-6 bg-white rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow text-center flex flex-col h-full">
                        <div class="bg-blue-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3"><i data-lucide="credit-card" class="w-6 h-6 text-blue-500"></i></div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Transferencia</h4>
                        <div class="text-sm text-gray-600 space-y-2 mb-6 flex-grow">
                            <p><span class="font-semibold block text-gray-800">Banco</span> BBVA Bancomer</p>
                            <p><span class="font-semibold block text-gray-800">Cuenta</span> 1234 5678 9012</p>
                            <p><span class="font-semibold block text-gray-800">CLABE</span> 012345678901234567</p>
                            <p><span class="font-semibold block text-gray-800">Titular</span> Juan y María</p>
                        </div>
                        <button id="btn-transfer-gift" class="w-full btn-secondary py-3 px-4 rounded-lg text-sm font-bold hover:opacity-90 transition-opacity mt-auto">Seleccionar Opción</button>
                    </div>
                    <!-- Opción 2 -->
                    <div class="p-6 bg-white rounded-xl border border-gray-100 shadow-sm hover:shadow-md transition-shadow text-center flex flex-col h-full">
                        <div class="bg-purple-50 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3"><i data-lucide="gift" class="w-6 h-6 text-purple-500"></i></div>
                        <h4 class="text-lg font-bold text-gray-800 mb-2">Regalo Físico</h4>
                        <div class="text-sm text-gray-600 mb-6 flex-grow flex items-center justify-center"><p>Contaremos con un buzón de sobres y mesa de regalos en la entrada de la recepción.</p></div>
                        <button id="btn-physical-gift" class="w-full btn-secondary py-3 px-4 rounded-lg text-sm font-bold hover:opacity-90 transition-opacity mt-auto">Seleccionar Opción</button>
                    </div>
                </div>
                <p id="gift-status-message" class="text-center text-md font-bold mt-6 text-primary-color"></p>
            </section>

            <!-- SECCIÓN 9: AGRADECIMIENTO (FONDO ROJO VISIBLE) -->
            <!-- Usamos style inline para forzar el color rojo (#A32D50) y texto blanco -->
            <section class="card p-8 text-center shadow-lg" style="background-color: var(--primary-color); color: white;">
                <p class="header-font text-3xl font-bold mb-1">"Tu Presencia es Nuestro Mejor Regalo"</p>
                <p class="text-lg">¡Gracias por ser parte de nuestra historia!</p>
            </section>
            <!-- FIN SECCIÓN AGRADECIMIENTO -->

        </div>
        
        <!-- MODO ADMINISTRADOR -->
        <div id="admin-view" class="hidden space-y-8 admin-view p-6 rounded-xl">
            <h2 class="header-font text-4xl font-bold text-center text-accent-color">Panel de Administración</h2>
            <div id="admin-controls" class="card p-6 space-y-4 bg-gray-800 text-white">
                <h3 class="text-2xl font-semibold border-b pb-2 border-gray-700 text-accent-color">Añadir/Editar Invitado</h3>
                <form id="add-guest-form" class="space-y-3">
                    <input type="text" id="input-guest-id" placeholder="ID del Invitado (Ej: maria_perez_123)" class="w-full p-2 rounded bg-gray-700 border border-gray-600" required>
                    <input type="text" id="input-guest-name" placeholder="Nombre del Invitado" class="w-full p-2 rounded bg-gray-700 border border-gray-600" required>
                    <input type="number" id="input-guest-table" placeholder="Mesa Asignada" class="w-full p-2 rounded bg-gray-700 border border-gray-600" required>
                    <input type="number" id="input-guests-allowed" placeholder="Invitados Permitidos (total)" class="w-full p-2 rounded bg-gray-700 border border-gray-600" required>
                    <button type="submit" class="btn-primary w-full py-2 rounded-lg font-bold">Guardar Invitado (Crea o Actualiza)</button>
                </form>
            </div>

            <div class="card p-6 bg-gray-800 text-white">
                <h3 class="text-2xl font-semibold mb-4 text-accent-color">Estado de Confirmaciones (RSVP)</h3>
                <div id="guest-list-container" class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700 text-sm">
                        <thead class="bg-gray-700">
                            <tr>
                                <th class="p-3 text-left font-semibold text-gray-300">Nombre</th>
                                <th class="p-3 text-left font-semibold text-gray-300">Mesa</th>
                                <th class="p-3 text-left font-semibold text-gray-300">Confirma</th>
                                <th class="p-3 text-left font-semibold text-gray-300">Teléfono</th>
                                <th class="p-3 text-left font-semibold text-gray-300">Regalo</th>
                                <th class="p-3 text-left font-semibold text-gray-300">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="admin-guest-list" class="divide-y divide-gray-700">
                            <!-- Lista de invitados cargada por JS -->
                        </tbody>
                    </table>
                </div>
                <p id="total-confirmed" class="mt-4 text-lg font-bold text-right text-green-400">Total Confirmados: 0</p>
            </div>
        </div>
    </main>

    <!-- Modal para Teléfono/WhatsApp -->
    <div id="whatsapp-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50 p-4">
        <div class="card w-full max-w-sm p-6 space-y-4">
            <h3 class="text-xl font-bold text-primary-color">Ingresa tu Teléfono</h3>
            <p class="text-sm text-gray-600">Opcional: Esto nos ayuda a contactarte en caso de emergencia. Si confirmas, también te llevaremos a WhatsApp para que envíes el mensaje de confirmación.</p>
            <input type="tel" id="input-phone-number" placeholder="Ej: 521XXXXXXXXX (Código de país + número)" class="w-full p-3 rounded-lg border border-gray-300 focus:ring-primary-color focus:border-primary-color">
            <div class="flex justify-end space-x-3">
                <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-lg transition-colors">Cancelar</button>
                <button id="modal-confirm-whatsapp-btn" class="btn-primary py-2 px-4 rounded-lg font-bold">Enviar y Confirmar</button>
            </div>
        </div>
    </div>


    <!-- FIREBASE AND JAVASCRIPT LOGIC -->
    <script type="module">
        // Importaciones de Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // ==============================================================================
        //  CONFIGURACIÓN DE FIREBASE 
        // ==============================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyCJfiyLFG0u2lid-DsPjkMX19toPLM45BY",
            authDomain: "invitaciones-digitales-c14a8.firebaseapp.com",
            projectId: "invitaciones-digitales-c14a8",
            storageBucket: "invitaciones-digitales-c14a8.firebasestorage.app",
            messagingSenderId: "661594120389",
            appId: "1:661594120389:web:c92f3afd853d7ddd0a50ac",
            measurementId: "G-9T9Q0HBNKR"
        };
        
        const appId = firebaseConfig.projectId || 'default-app-id';
        
        setLogLevel('Debug');
        
        let app, db, auth, currentUserId;
        let currentGuestId = null;
        let currentGuestData = null;
        let isAdminMode = false;


        // --- CONSTANTES ---
        const EVENT_DATE = new Date("December 31, 2025 20:00:00").getTime(); 
        const ADMIN_PASSCODE = "12345"; 
        const HOST_PHONE_NUMBER = "5215512345678"; 
        const GITHUB_PAGES_BASE_URL = "https://jorge863z.github.io/invitacion-digital/";
        
        const LOCATIONS = [
            {
                id: 'ceremony',
                title: 'Ceremonia (Templo)',
                address: 'Parroquia de San Miguel Arcángel, Col. Centro, CDMX',
                time: '16:00 hrs',
                mapLink: 'https://maps.app.goo.gl/EJXJj8UfK8zN15x88'
            },
            {
                id: 'reception',
                title: 'Recepción y Fiesta',
                address: 'Salón de Eventos Esmeralda, Av. 5, Col. Juárez, CDMX',
                time: '19:00 hrs',
                mapLink: 'https://maps.app.goo.gl/L9F9w2QvQ3Q5e9k77'
            }
        ];
        
        const EVENT_DETAILS = {
            dressCode: "Formal de Noche (Colores claros no son recomendados)",
        };

        const GUESTS_COLLECTION_PATH = `artifacts/${appId}/public/data/invitations`;
        
        // --- FUNCIONES UI ---
        function showToast(message, type = 'success', extraContent = null) {
            const toast = document.getElementById('toast-message');
            toast.classList.remove('link-toast', 'bg-green-500', 'bg-red-500', 'bg-blue-500', 'hidden', 'opacity-0');
            toast.textContent = ''; 
            
            if (type === 'success') toast.classList.add('bg-green-500');
            else if (type === 'error') toast.classList.add('bg-red-500');
            else toast.classList.add('bg-blue-500');

            if (extraContent) {
                toast.classList.add('link-toast');
                toast.innerHTML = `<div class="p-4">${message}</div>${extraContent}`;
            } else {
                 toast.textContent = message;
                 toast.classList.add('p-4');
            }
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
                setTimeout(() => toast.classList.add('hidden'), 300);
            }, 8000);
        }

        function copyToClipboard(text) {
            const el = document.createElement('textarea');
            el.value = text;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast('¡Enlace copiado al portapapeles!', 'success');
        }
        window.copyToClipboard = copyToClipboard;

        function toggleAdminView(enable) {
            const guestView = document.getElementById('guest-view');
            const adminView = document.getElementById('admin-view');
            const container = document.getElementById('app-container');
            isAdminMode = enable;

            if (enable) {
                guestView.classList.add('hidden');
                adminView.classList.remove('hidden');
                container.classList.add('admin-view', 'max-w-7xl');
                document.getElementById('admin-login-btn').classList.add('hidden');
                if (db) listenToAllGuests();
            } else {
                guestView.classList.remove('hidden');
                adminView.classList.add('hidden');
                container.classList.remove('admin-view', 'max-w-7xl');
                document.getElementById('admin-login-btn').classList.remove('hidden');
            }
        }

        // --- FIREBASE INIT ---
        async function initializeFirebase() {
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes('TU_API_KEY')) {
                 showToast("Error: Configuración de Firebase incompleta.", 'error');
                 return;
            }
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        const urlParams = new URLSearchParams(window.location.search);
                        currentGuestId = urlParams.get('guestId');

                        if (isAdminMode) listenToAllGuests();
                        else if (currentGuestId) listenToGuestDetails(currentGuestId);
                        else {
                            document.getElementById('guest-details-loading').textContent = "Por favor, utiliza el enlace que se te proporcionó.";
                            document.getElementById('guest-details').classList.add('hidden');
                        }
                    }
                });
            } catch (error) {
                console.error("Firebase Init Error:", error);
            }
        }
        
        function renderLocations() {
            const container = document.getElementById('location-container');
            container.innerHTML = ''; 
            LOCATIONS.forEach(loc => {
                const icon = loc.id === 'ceremony' ? 'church' : (loc.id === 'reception' ? 'party-popper' : 'map-pin');
                container.innerHTML += `
                    <div id="location-${loc.id}" class="p-4 bg-gray-50 rounded-lg border border-gray-200 space-y-3">
                        <div class="flex items-center text-primary-color">
                             <i data-lucide="${icon}" class="w-6 h-6 mr-2"></i>
                             <h3 class="text-xl font-bold">${loc.title}</h3>
                        </div>
                        <p class="text-sm">${loc.address}</p>
                        <p class="text-sm font-semibold">${loc.time}</p>
                        <a href="${loc.mapLink}" target="_blank" class="block btn-secondary text-center py-2 rounded-lg text-sm font-semibold hover:opacity-90 transition-opacity">
                            <i data-lucide="map-pin" class="w-4 h-4 mr-1 inline-block"></i> Ver en Google Maps
                        </a>
                    </div>
                `;
            });
            lucide.createIcons();
        }

        function renderDressCode() {
            document.getElementById('dress-code').textContent = EVENT_DETAILS.dressCode;
        }

        // --- GESTIÓN DE INVITADO ---
        function listenToGuestDetails(guestId) {
            const guestRef = doc(db, GUESTS_COLLECTION_PATH, guestId);
            document.getElementById('guest-details-loading').classList.remove('hidden');
            onSnapshot(guestRef, (docSnap) => {
                document.getElementById('guest-details-loading').classList.add('hidden');
                if (docSnap.exists()) {
                    currentGuestData = docSnap.data();
                    document.getElementById('guest-details').classList.remove('hidden');
                    renderGuestView(currentGuestData);
                } else {
                    document.getElementById('guest-details-loading').textContent = `Invitado con ID '${guestId}' no encontrado.`;
                    document.getElementById('guest-details').classList.add('hidden');
                }
            });
        }

        function renderGuestView(data) {
            document.getElementById('guest-name-display').textContent = data.name || 'Invitado(a)';
            document.getElementById('guest-table-display').textContent = data.table || 'N/A';
            document.getElementById('guest-count-display').textContent = data.guestsAllowed || '1';

            const rsvpMessage = document.getElementById('rsvp-status-message');
            const giftActions = document.getElementById('gift-actions');
            const rsvpActions = document.getElementById('rsvp-actions');
            
            let rsvpStatus = data.rsvpStatus || 'Pending';
            let giftDecision = data.giftDecision || 'Pending';

            if (rsvpStatus === 'Confirmed') {
                rsvpMessage.textContent = '¡Tu asistencia ha sido confirmada! ¡Gracias!';
                rsvpMessage.classList.add('text-green-600');
                rsvpActions.classList.add('opacity-50', 'pointer-events-none');
            } else if (rsvpStatus === 'Not Attending') {
                rsvpMessage.textContent = 'Lamentamos que no puedas asistir.';
                rsvpMessage.classList.add('text-red-500');
                rsvpActions.classList.add('opacity-50', 'pointer-events-none');
            } else {
                rsvpMessage.textContent = 'Por favor, confirma tu asistencia.';
                rsvpMessage.classList.remove('text-green-600', 'text-red-500');
                rsvpActions.classList.remove('opacity-50', 'pointer-events-none');
            }
            
            const giftMsg = document.getElementById('gift-status-message');
            if (giftDecision !== 'Pending') {
                giftMsg.textContent = `Tu decisión de regalo es: ${giftDecision === 'Transfer' ? 'Transferencia' : 'Físico'}.`;
                giftActions.classList.add('opacity-50', 'pointer-events-none');
            } else {
                giftMsg.textContent = '';
                giftActions.classList.remove('opacity-50', 'pointer-events-none');
            }
        }

        async function updateRsvp(status, phone = '') {
            if (!currentGuestId || !db) return;
            const guestRef = doc(db, GUESTS_COLLECTION_PATH, currentGuestId);
            const updateData = { rsvpStatus: status, rsvpDate: new Date(), ...(phone && { guestPhone: phone }) };
            await setDoc(guestRef, updateData, { merge: true });
            showToast(`Estado actualizado: ${status}`, 'success');
            if (status === 'Confirmed' && phone) {
                const msg = encodeURIComponent(`Hola, confirmo asistencia. Soy ${currentGuestData?.name}.`);
                window.open(`https://wa.me/${HOST_PHONE_NUMBER}?text=${msg}`, '_blank');
            }
        }

        async function updateGiftDecision(decision) {
            if (!currentGuestId || !db) return;
            const guestRef = doc(db, GUESTS_COLLECTION_PATH, currentGuestId);
            await setDoc(guestRef, { giftDecision: decision }, { merge: true });
            showToast('Decisión de regalo guardada.', 'success');
        }
        
        async function deleteGuest(guestId) {
            if (!confirm(`¿Eliminar invitado ${guestId}?`)) return;
            if (!db) return;
            const guestRef = doc(db, GUESTS_COLLECTION_PATH, guestId);
            await deleteDoc(guestRef);
            showToast('Invitado eliminado.', 'success');
        }

        function listenToAllGuests() {
            if (!db) return;
            const q = collection(db, GUESTS_COLLECTION_PATH);
            onSnapshot(q, (snapshot) => {
                let totalConfirmed = 0;
                const guestListBody = document.getElementById('admin-guest-list');
                guestListBody.innerHTML = ''; 
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const id = doc.id;
                    if (data.rsvpStatus === 'Confirmed') totalConfirmed += (data.guestsAllowed || 1);
                    const row = guestListBody.insertRow();
                    row.innerHTML = `
                        <td class="p-3 font-semibold">${data.name || id}</td>
                        <td class="p-3">${data.table || 'N/A'}</td>
                        <td class="p-3">${data.rsvpStatus || 'Pending'}</td>
                        <td class="p-3">${data.guestPhone || '-'}</td>
                        <td class="p-3">${data.giftDecision || '-'}</td>
                        <td class="p-3"><button onclick="window.deleteGuest('${id}')" class="text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                    `;
                });
                lucide.createIcons();
                document.getElementById('total-confirmed').textContent = `Total Confirmados: ${totalConfirmed}`;
            });
        }

        window.deleteGuest = deleteGuest; 

        document.getElementById('add-guest-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const guestId = document.getElementById('input-guest-id').value.trim();
            const name = document.getElementById('input-guest-name').value.trim();
            const table = parseInt(document.getElementById('input-guest-table').value, 10);
            const guestsAllowed = parseInt(document.getElementById('input-guests-allowed').value, 10);
            
            if (!db || !guestId) return;

            const guestRef = doc(db, GUESTS_COLLECTION_PATH, guestId);
            const docSnap = await getDoc(guestRef); 
            
            const guestData = { name, table, guestsAllowed };
            let actionType = '';
            
            if (docSnap.exists()) {
                await setDoc(guestRef, guestData, { merge: true });
                actionType = 'actualizado';
            } else {
                await setDoc(guestRef, { ...guestData, rsvpStatus: 'Pending', giftDecision: 'Pending' }, { merge: false });
                actionType = 'creado';
            }
            
            const fullLink = `${GITHUB_PAGES_BASE_URL}invitacion.html?guestId=${guestId}`;
            const extraContentHTML = `<div class="p-4 bg-gray-700 w-full flex items-center space-x-4"><input type="text" value="${fullLink}" class="w-full text-xs text-black p-2 rounded" readonly /><button onclick="window.copyToClipboard('${fullLink}')" class="text-white font-bold">Copiar</button></div>`;
            showToast(`Invitado ${actionType}.`, 'success', extraContentHTML);
            document.getElementById('input-guest-id').value = '';
        });

        function updateCountdown() {
            const now = new Date().getTime();
            const distance = EVENT_DATE - now;
            const countdownEl = document.getElementById('countdown');

            if (distance < 0) {
                countdownEl.innerHTML = '<p class="col-span-5 text-lg font-bold text-red-600">¡YA ES HOY!</p>';
                return;
            }

            const days = Math.floor(distance / (1000 * 60 * 60 * 24));
            const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            
            // Lógica de meses aproximada para visualización
            const months = Math.floor(days / 30);
            const remainingDays = days % 30;

            if (window.innerWidth < 640) {
                 countdownEl.innerHTML = `
                    <div class="countdown-item col-span-3"><p>${months}</p><p class="text-xs uppercase">Meses</p></div>
                    <div class="countdown-item col-span-3"><p>${remainingDays}</p><p class="text-xs uppercase">Días</p></div>
                    <div class="countdown-item col-span-2"><p>${hours}</p><p class="text-xs uppercase">Hrs</p></div>
                    <div class="countdown-item col-span-2"><p>${minutes}</p><p class="text-xs uppercase">Min</p></div>
                    <div class="countdown-item col-span-2"><p>${seconds}</p><p class="text-xs uppercase">Seg</p></div>
                `;
                 countdownEl.className = "grid grid-cols-6 gap-3 text-primary-color font-mono";
            } else {
                 countdownEl.innerHTML = `
                    <div class="countdown-item"><p>${months}</p><p class="text-xs uppercase">Meses</p></div>
                    <div class="countdown-item"><p>${remainingDays}</p><p class="text-xs uppercase">Días</p></div>
                    <div class="countdown-item"><p>${hours}</p><p class="text-xs uppercase">Horas</p></div>
                    <div class="countdown-item"><p>${minutes}</p><p class="text-xs uppercase">Minutos</p></div>
                    <div class="countdown-item"><p>${seconds}</p><p class="text-xs uppercase">Segundos</p></div>
                 `;
                 countdownEl.className = "grid grid-cols-5 gap-2 text-primary-color font-mono";
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            renderDressCode();
            renderLocations();
            lucide.createIcons();

            // Init Lightbox
            const lightbox = document.getElementById('lightbox');
            const lightboxImg = document.getElementById('lightbox-img');
            const closeBtn = document.getElementById('lightbox-close');
            document.querySelectorAll('.gallery-img').forEach(img => {
                img.addEventListener('click', function() {
                    lightbox.classList.add('active');
                    lightboxImg.src = this.src;
                });
            });
            closeBtn.addEventListener('click', () => lightbox.classList.remove('active'));
            lightbox.addEventListener('click', (e) => { if(e.target === lightbox) lightbox.classList.remove('active'); });

            updateCountdown();
            setInterval(updateCountdown, 1000);
            initializeFirebase();
            
            document.getElementById('btn-confirm-attendance').addEventListener('click', () => updateRsvp('Confirmed'));
            document.getElementById('btn-not-attending').addEventListener('click', () => updateRsvp('Not Attending'));
            document.getElementById('btn-whatsapp-prompt').addEventListener('click', () => {
                document.getElementById('whatsapp-modal').classList.remove('hidden');
                document.getElementById('whatsapp-modal').classList.add('flex');
            });
            document.getElementById('modal-cancel-btn').addEventListener('click', () => {
                document.getElementById('whatsapp-modal').classList.add('hidden');
                document.getElementById('whatsapp-modal').classList.remove('flex');
            });
            document.getElementById('modal-confirm-whatsapp-btn').addEventListener('click', () => {
                const phone = document.getElementById('input-phone-number').value;
                updateRsvp('Confirmed', phone);
                document.getElementById('whatsapp-modal').classList.add('hidden');
                document.getElementById('whatsapp-modal').classList.remove('flex');
            });
            document.getElementById('btn-transfer-gift').addEventListener('click', () => updateGiftDecision('Transfer'));
            document.getElementById('btn-physical-gift').addEventListener('click', () => updateGiftDecision('Physical'));
            document.getElementById('admin-login-btn').addEventListener('click', () => {
                const p = prompt("Código Admin:");
                if (p === ADMIN_PASSCODE) toggleAdminView(true);
            });
        });
    </script>
</body>
</html>

